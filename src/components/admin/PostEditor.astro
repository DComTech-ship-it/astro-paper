---
interface Props {
  title?: string;
  content?: string;
  excerpt?: string;
  tags?: string[];
  status?: 'draft' | 'published' | 'scheduled';
  publishDate?: string;
  author?: string;
  slug?: string;
  featured?: boolean;
}

const {
  title = '',
  content = '',
  excerpt = '',
  tags = [],
  status = 'draft',
  publishDate = new Date().toISOString().split('T')[0],
  author = 'Dxmond Tecku',
  slug = '',
  featured = false
} = Astro.props;

// Generate slug from title if not provided
const generateSlug = (title: string) => {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9 -]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
};
---

<div class="post-editor">
  <!-- Main Content Area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Editor Column -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-lg font-medium text-gray-900">Content</h2>
        </div>
        
        <div class="p-6 space-y-6">
          <!-- Title Input -->
          <div>
            <label for="post-title" class="block text-sm font-medium text-gray-700 mb-2">
              Title *
            </label>
            <input
              type="text"
              id="post-title"
              name="title"
              value={title}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent text-lg"
              placeholder="Enter post title..."
              oninput="updateSlug(this.value)"
            />
          </div>

          <!-- Slug Input -->
          <div>
            <label for="post-slug" class="block text-sm font-medium text-gray-700 mb-2">
              URL Slug *
            </label>
            <div class="flex">
              <span class="inline-flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-r-0 border-gray-300 rounded-l-md">
                /blog/
              </span>
              <input
                type="text"
                id="post-slug"
                name="slug"
                value={slug}
                required
                class="flex-1 px-3 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
                placeholder="url-friendly-slug"
              />
            </div>
          </div>

          <!-- Excerpt Input -->
          <div>
            <label for="post-excerpt" class="block text-sm font-medium text-gray-700 mb-2">
              Excerpt
            </label>
            <textarea
              id="post-excerpt"
              name="excerpt"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
              placeholder="Brief description of the post..."
            >{excerpt}</textarea>
            <p class="mt-1 text-sm text-gray-500">
              Used for SEO and social media previews
            </p>
          </div>

          <!-- Content Editor -->
          <div>
            <label for="post-content" class="block text-sm font-medium text-gray-700 mb-2">
              Content *
            </label>
            <div class="border border-gray-300 rounded-md overflow-hidden">
              <!-- Editor Toolbar -->
              <div class="bg-gray-50 border-b border-gray-200 px-3 py-2 flex items-center space-x-2">
                <button
                  type="button"
                  onclick="insertMarkdown('**', '**')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Bold"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h16v4H6z"/>
                  </svg>
                </button>
                <button
                  type="button"
                  onclick="insertMarkdown('*', '*')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Italic"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4h4M14 4v16M10 20h4"/>
                  </svg>
                </button>
                <button
                  type="button"
                  onclick="insertMarkdown('# ', '')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Heading"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                  </svg>
                </button>
                <div class="h-4 w-px bg-gray-300"></div>
                <button
                  type="button"
                  onclick="insertMarkdown('[', ']')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Link"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                  </svg>
                </button>
                <button
                  type="button"
                  onclick="insertMarkdown('`', '`')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Code"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                  </svg>
                </button>
                <div class="h-4 w-px bg-gray-300"></div>
                <button
                  type="button"
                  onclick="insertMarkdown('\n- ', '')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="List"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                  </svg>
                </button>
                <button
                  type="button"
                  onclick="insertMarkdown('\n> ', '')"
                  class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded"
                  title="Quote"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01"/>
                  </svg>
                </button>
              </div>
              
              <!-- Textarea -->
              <textarea
                id="post-content"
                name="content"
                rows="20"
                required
                class="w-full px-3 py-2 border-0 focus:outline-none focus:ring-0 resize-y font-mono text-sm"
                placeholder="Write your post content in Markdown..."
              >{content}</textarea>
            </div>
            
            <!-- Preview Toggle -->
            <div class="mt-2 flex items-center justify-between">
              <span class="text-sm text-gray-500">Markdown supported</span>
              <button
                type="button"
                onclick="togglePreview()"
                class="text-sm text-accent hover:text-accent/80 font-medium"
              >
                Preview
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <!-- Publish Settings -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-lg font-medium text-gray-900">Publish Settings</h2>
        </div>
        
        <div class="p-6 space-y-4">
          <!-- Status -->
          <div>
            <label for="post-status" class="block text-sm font-medium text-gray-700 mb-2">
              Status
            </label>
            <select
              id="post-status"
              name="status"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
            >
              <option value="draft" selected={status === 'draft'}>Draft</option>
              <option value="published" selected={status === 'published'}>Published</option>
              <option value="scheduled" selected={status === 'scheduled'}>Scheduled</option>
            </select>
          </div>

          <!-- Publish Date -->
          <div>
            <label for="publish-date" class="block text-sm font-medium text-gray-700 mb-2">
              Publish Date
            </label>
            <input
              type="date"
              id="publish-date"
              name="publishDate"
              value={publishDate}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
            />
          </div>

          <!-- Author -->
          <div>
            <label for="post-author" class="block text-sm font-medium text-gray-700 mb-2">
              Author
            </label>
            <input
              type="text"
              id="post-author"
              name="author"
              value={author}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
            />
          </div>

          <!-- Featured -->
          <div>
            <label class="flex items-center">
              <input
                type="checkbox"
                id="post-featured"
                name="featured"
                checked={featured}
                class="rounded border-gray-300 text-accent focus:ring-accent"
              />
              <span class="ml-2 text-sm text-gray-700">Featured post</span>
            </label>
          </div>

          <!-- Save Buttons -->
          <div class="space-y-2">
            <button
              type="button"
              onclick="savePost('draft')"
              class="w-full px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent"
            >
              Save Draft
            </button>
            <button
              type="button"
              onclick="savePost('published')"
              class="w-full px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-accent hover:bg-accent/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent"
            >
              Publish
            </button>
          </div>
        </div>
      </div>

      <!-- Tags -->
      <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200 px-6 py-4">
          <h2 class="text-lg font-medium text-gray-900">Tags</h2>
        </div>
        
        <div class="p-6">
          <div class="mb-3">
            <input
              type="text"
              id="tag-input"
              placeholder="Add tags..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
              onkeypress="handleTagInput(event)"
            />
          </div>
          
          <div id="tags-container" class="flex flex-wrap gap-2">
            {tags.map((tag) => (
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-accent/10 text-accent">
                {tag}
                <button
                  type="button"
                  onclick="removeTag('{tag}')"
                  class="ml-2 text-accent hover:text-accent/80"
                >
                  ×
                </button>
              </span>
            ))}
          </div>
          
          <p class="mt-2 text-sm text-gray-500">
            Press Enter or comma to add tags
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="preview-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="togglePreview()"></div>
      
      <div class="relative bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 class="text-lg font-medium">Preview</h3>
          <button
            type="button"
            onclick="togglePreview()"
            class="text-gray-400 hover:text-gray-500"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
          <div id="preview-content" class="prose max-w-none"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentTags = [];

  function updateSlug(title) {
    const slugInput = document.getElementById('post-slug');
    if (slugInput && !slugInput.dataset.manual) {
      slugInput.value = title
        .toLowerCase()
        .replace(/[^a-z0-9 -]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
    }
  }

  function insertMarkdown(before, after) {
    const textarea = document.getElementById('post-content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);
    
    const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
    textarea.value = newText;
    
    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
  }

  function handleTagInput(event) {
    if (event.key === 'Enter' || event.key === ',') {
      event.preventDefault();
      const input = event.target;
      const tag = input.value.trim();
      
      if (tag && !currentTags.includes(tag)) {
        addTag(tag);
        input.value = '';
      }
    }
  }

  function addTag(tag) {
    currentTags.push(tag);
    updateTagsDisplay();
  }

  function removeTag(tag) {
    currentTags = currentTags.filter(t => t !== tag);
    updateTagsDisplay();
  }

  function updateTagsDisplay() {
    const container = document.getElementById('tags-container');
    container.innerHTML = currentTags.map(tag => `
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-accent/10 text-accent">
        ${tag}
        <button type="button" onclick="removeTag('${tag}')" class="ml-2 text-accent hover:text-accent/80">×</button>
      </span>
    `).join('');
  }

  function togglePreview() {
    const modal = document.getElementById('preview-modal');
    const content = document.getElementById('post-content').value;
    const preview = document.getElementById('preview-content');
    
    if (modal.classList.contains('hidden')) {
      // Convert basic markdown to HTML for preview
      preview.innerHTML = content
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*)\*/gim, '<em>$1</em>')
        .replace(/`(.*)`/gim, '<code>$1</code>')
        .replace(/\n\n/gim, '</p><p>')
        .replace(/\n/gim, '<br>');
      
      modal.classList.remove('hidden');
    } else {
      modal.classList.add('hidden');
    }
  }

  async function savePost(status) {
    const formData = new FormData();
    const postData = {
      title: document.getElementById('post-title').value,
      slug: document.getElementById('post-slug').value,
      excerpt: document.getElementById('post-excerpt').value,
      content: document.getElementById('post-content').value,
      status: status,
      publishDate: document.getElementById('publish-date').value,
      author: document.getElementById('post-author').value,
      featured: document.getElementById('post-featured').checked,
      tags: currentTags
    };

    try {
      // Get current post ID from URL if editing
      const urlPath = window.location.pathname;
      const isEdit = urlPath.includes('/edit/');
      let apiUrl = '/api/admin/posts';
      let method = 'POST';

      if (isEdit) {
        const postId = urlPath.split('/edit/')[1];
        apiUrl = `/api/admin/posts/${postId}`;
        method = 'PUT';
      }

      const response = await fetch(apiUrl, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(postData)
      });

      const result = await response.json();

      if (response.ok && result.success) {
        alert(`Post ${status === 'published' ? 'published' : 'saved as draft'} successfully!`);
        if (!isEdit) {
          window.location.href = '/admin/posts';
        }
      } else {
        alert(result.error || 'Failed to save post');
      }
    } catch (error) {
      console.error('Save post error:', error);
      alert('Error saving post. Please try again.');
    }
  }

  // Mark slug as manually edited
  document.getElementById('post-slug')?.addEventListener('input', function() {
    this.dataset.manual = 'true';
  });
</script>
